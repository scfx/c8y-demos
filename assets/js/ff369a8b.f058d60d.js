"use strict";(self.webpackChunkc_8_y_docs=self.webpackChunkc_8_y_docs||[]).push([[6828],{2850:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>s,contentTitle:()=>r,default:()=>h,frontMatter:()=>c,metadata:()=>a,toc:()=>d});var i=t(4848),o=t(8453);const c={sidebar_position:1},r="OPCUA",a={id:"protocols/opcua",title:"OPCUA",description:"This solution combines thin-edge.io and the OPC UA Gateway Agent together with a sample OPC UA Server.",source:"@site/docs/protocols/opcua.md",sourceDirName:"protocols",slug:"/protocols/opcua",permalink:"/c8y-demos/docs/protocols/opcua",draft:!1,unlisted:!1,editUrl:"https://github.com/scfx/c8y-demos/docs/protocols/opcua.md",tags:[],version:"current",sidebarPosition:1,frontMatter:{sidebar_position:1},sidebar:"tutorialSidebar",previous:{title:"Device protocols",permalink:"/c8y-demos/docs/category/device-protocols"},next:{title:"LWM2M",permalink:"/c8y-demos/docs/protocols/lwm2m"}},s={},d=[{value:"dockerfile content",id:"dockerfile-content",level:2},{value:"dockerfile content",id:"dockerfile-content-1",level:2},{value:"dockerfile content",id:"dockerfile-content-2",level:2}];function l(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",img:"img",p:"p",pre:"pre",...(0,o.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.h1,{id:"opcua",children:"OPCUA"}),"\n",(0,i.jsx)(n.p,{children:"This solution combines thin-edge.io and the OPC UA Gateway Agent together with a sample OPC UA Server."}),"\n",(0,i.jsx)(n.p,{children:"See as well for additional information:"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.a,{href:"https://cumulocity.com/guides/protocol-integration/opcua/",children:"OPC UA Agent Cumulocity"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.a,{href:"https://thin-edge.io",children:"thin-edge.io"})}),"\n",(0,i.jsx)(n.p,{children:"The architecture allows that other components can be used on thin-edge.io. This is possible due to the concepct of using mqtt as the underlying messaging broker. The module can be programmed in any language but needs to understand mqtt and its payload/topic structure."}),"\n",(0,i.jsx)(n.p,{children:"However thats where a modified version of the OPC UA Gateway agent can be used. In this solution the steps to create that solution as well as the underlying idea are described."}),"\n",(0,i.jsx)("br",{}),"\n",(0,i.jsx)("br",{}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Image",src:t(7312).A+"",width:"1164",height:"553"})}),"\n",(0,i.jsx)(n.h1,{id:"quickstart",children:"Quickstart"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"git clone \ncd thin_edge.io_examples/opcua-solution\n"})}),"\n",(0,i.jsx)(n.p,{children:"Modify the values within the .env file. Make espacially sure that you have an proper device ID for thin-edge.io."}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{src:"https://g.recordit.co/Xsp3xYZTp7.gif",alt:"docker-compose"})}),"\n",(0,i.jsx)(n.p,{children:"As soon as thin-edge.io is started, log into that container via"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"docker exec -it thin-edge.io sh\n"})}),"\n",(0,i.jsx)(n.p,{children:"You have to upload the created device certificate. You can do that via:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"tedge cert upload c8y --user {YOURUSERNAME}\n"})}),"\n",(0,i.jsx)(n.p,{children:"Enter your password and the certificate will be updated. Connect thin-edge.io via:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"sudo tedge connect c8y\n"})}),"\n",(0,i.jsx)(n.p,{children:"The device will appear in the device list, the opcua gateway agent will be a child device of this device."}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{src:"https://g.recordit.co/I7s3OMhNT5.gif",alt:"device-connect"})}),"\n",(0,i.jsx)(n.p,{children:"Until the device is not proper connected and the MQTT broker is not running proper, the OPC UA Gateway Agent will fail to start. You need to start that again after the proper connect of thin-edge.io to cumulocity."}),"\n",(0,i.jsx)(n.h1,{id:"thin-edgeio",children:"thin-edge.io"}),"\n",(0,i.jsx)(n.p,{children:"Thin-edge.io is here deploayed as a docker container on the basis of an alpine image. Feel free to adjust. Some steps are already packed into the building process such as creating the device certificate based on the device id. The uploading of the certificate needs to be handled manually via"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"tedge cert upload c8y --user\n"})}),"\n",(0,i.jsx)(n.p,{children:"However if you use your own certificate this step can be ignored but you need to copy your certificate into /etc/tedge/device-certs while building."}),"\n",(0,i.jsx)(n.h2,{id:"dockerfile-content",children:"dockerfile content"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-docker",children:"  tedge:\n    build:\n      context: ./tedge\n      args:\n        - URL=${baseUrl}\n        - DEVICEID=${deviceID}\n    container_name: thin-edge.io\n    env_file:\n      - .env\n    volumes:\n    - /var/run/docker.sock:/var/run/docker.sock\n    restart: on-failure \n"})}),"\n",(0,i.jsx)(n.h1,{id:"opc-simulation-server",children:"OPC Simulation Server"}),"\n",(0,i.jsx)(n.p,{children:"The Simulation Server simulates a machine within a factory. Values are updated every 2s."}),"\n",(0,i.jsx)("br",{}),"\n",(0,i.jsx)("br",{}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Image",src:t(3971).A+"",width:"1378",height:"873"})}),"\n",(0,i.jsx)(n.p,{children:"You can change the tree before building the container."}),"\n",(0,i.jsx)(n.p,{children:"Once the gateway scanned the OPCTree you can view its content within the device management and the corresponding device."}),"\n",(0,i.jsx)(n.h2,{id:"dockerfile-content-1",children:"dockerfile content"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-docker",children:'  opcserver:\n      build:\n        context: ./opcserver\n      ports:\n        - "4841:4840"\n      expose:\n        - "4841"\n      container_name: opc-simulation\n      restart: on-failure \n'})}),"\n",(0,i.jsx)(n.h1,{id:"opc-ua-gateway",children:"OPC UA Gateway"}),"\n",(0,i.jsx)(n.p,{children:"The device representation of the OPC UA Gateway is a child-device for the thin-edge.io parent device."}),"\n",(0,i.jsx)(n.p,{children:"To connect to the simulation OPC UA server enter url opc.tcp://opcserver:4840 or the url of the real OPC UA Server."}),"\n",(0,i.jsx)("br",{}),"\n",(0,i.jsx)("br",{}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{src:"http://g.recordit.co/i7wj3cbYQm.gif",alt:"OPC Server"})}),"\n",(0,i.jsx)(n.p,{children:"You can define which data points are translated in the device protocol section of cumulocity."}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{src:"http://g.recordit.co/MfiIY4GZmM.gif",alt:"Device Protocol"})}),"\n",(0,i.jsxs)(n.p,{children:["You can find more about the OPC UA Gateway implementation in the official ",(0,i.jsx)(n.a,{href:"https://cumulocity.com/guides/protocol-integration/opcua/",children:"documentation"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"For the device protocoll a new device as child device of the OPC UA Server will be registered. The mapped measurements can be found there."}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Measurements",src:t(3127).A+"",width:"1383",height:"878"})}),"\n",(0,i.jsx)(n.p,{children:"Until the device is not proper connected and the MQTT broker is not running proper, the OPC UA Gateway Agent will fail to start."}),"\n",(0,i.jsx)(n.h2,{id:"dockerfile-content-2",children:"dockerfile content"}),"\n",(0,i.jsx)(n.p,{children:"Within docker-compose the part of gateway defines the parameters for the OPC UA Gateway agent. The"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-docker",children:"  gateway:\n      build:\n        context: ./gateway\n      container_name: opc-gateway\n      restart: always \n      env_file:\n        - .env\n      depends_on:\n        - tedge\n      volumes:\n      - ./data/opcua/:/data\n"})}),"\n",(0,i.jsx)(n.p,{children:"The registration data are stored in the ./data directory that are mapped as a volume to the docker service gateway."})]})}function h(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(l,{...e})}):l(e)}},3127:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/Measurements-1b693860aa9e6ef5fc06ac7cf4d01761.png"},3971:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/OPC_Tree-9c00264a33831c55e0ec3a740cb0bc8c.png"},7312:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/thin-edge-diagram-6ad1f446326a4ddfdf5163da4158b578.svg"},8453:(e,n,t)=>{t.d(n,{R:()=>r,x:()=>a});var i=t(6540);const o={},c=i.createContext(o);function r(e){const n=i.useContext(c);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:r(e.components),i.createElement(c.Provider,{value:n},e.children)}}}]);